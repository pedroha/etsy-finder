<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Etsy Search Products</title>
</head>
<body>
	<script src="js/jquery.js"></script>
	<script src="js/etsy.js"></script>

	<div id="products"></div>

	<script>

		var deferred = EtsySearch.find();

		deferred.done(function(products) {
			// alert("FIN. See console.");

			/*
			console.log( products );

			// Check we got all the images
			for (var i = 0; i < products.length; i++) {
				var p = products[i];

				if (!!p.images) {
					console.log(p.listing_id + " has images: " + p.images.length);
				}
				else {
					console.log(p.listing_id + " has no images");
				}
			}
			*/
			var list = [];

			for (var i = 0; i < products.length; i++) {
				var p = products[i];
				var item = {
					id: p.listing_id
				  , title: p.title
				  , description: p.description
				  , price: p.price
				  , currency_code: p.currency_code
				};
				if (p.images && p.images.length > 0) {
					var img = p.images[0];
					item['url_170x135']   = img['url_170x135'];
					item['url_fullxfull'] = img['url_fullxfull'];
				}
				list.push(item);
			}
			showModel(list);
		});

		function showModel(list) {
			var template = [
				'<li>\n'
			  , '   <img src="%url_170x135%"/>'
			  , '   <p>%title%</p>'
			  , '</li>'
			];

			var tmpl = template.join('');

			var pieces = [];

			for (var i = 0; i < list.length; i++) {
				var it = list[i];
				var s = tmpl.replace("%url_170x135%", it['url_170x135'])
						    .replace("%title%", it['title']);

				pieces.push(s);

			}
			var $list = $('<ul>');
			$list.append( pieces.join('') );
			$('#products').append($list);
		}

	</script>
</body>
</html>